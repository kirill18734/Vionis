from PyQt5.QtCore import QSize, QTimer
from PyQt5.QtGui import QIcon
from PyQt5.QtWidgets import QApplication, QMainWindow
from .app import   Ui_MainWindow
from UI.app.styles.style_main import DARK_STYLE as DARK_MAIN, LIGHT_STYLE as LIGHT_MAIN
from UI.app.styles.style_commands import DARK_STYLE as DARK_COMMANDS, LIGHT_STYLE as LIGHT_COMMANDS
from UI.app.styles.style_settings import DARK_STYLE as DARK_SETTINGS, LIGHT_STYLE as LIGHT_SETTINGS
import sys
from config import load_config, save_config, Github_icon_white, Github_icon_black

from PyQt5.QtWidgets import QCheckBox
from PyQt5.QtCore import Qt, QPropertyAnimation, QEasingCurve, pyqtProperty
from PyQt5.QtGui import QPainter, QColor, QMouseEvent


class ToggleSwitch(QCheckBox):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setFixedSize(50, 25)
        self._circle_pos_internal = 3
        self.setCursor(Qt.PointingHandCursor)
        self.setFocusPolicy(Qt.NoFocus)

        self.animation = QPropertyAnimation(self, b"circle_position")
        self.animation.setDuration(200)
        self.animation.setEasingCurve(QEasingCurve.InOutQuad)

        self.stateChanged.connect(self.start_transition)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∏ –≤—ã–≤–æ–¥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

    def mouseReleaseEvent(self, event: QMouseEvent):
        if event.button() == Qt.LeftButton:
            self.toggle()
        super().mouseReleaseEvent(event)

    def start_transition(self, value):
        start = self._circle_pos_internal
        end = self.width() - self.height() + 3 if value else 3

        self.animation.stop()
        self.animation.setStartValue(start)
        self.animation.setEndValue(end)
        self.animation.start()

    def paintEvent(self, event):
        p = QPainter(self)
        p.setRenderHint(QPainter.Antialiasing)
        p.setPen(Qt.NoPen)

        # –§–æ–Ω
        p.setBrush(QColor("green") if self.isChecked() else QColor("red") if load_config().get("theme",
                                                                                               "light") == 'dark' else QColor(
            "gray"))
        p.drawRoundedRect(0, 0, self.width(), self.height(), self.height() / 2, self.height() / 2)

        # –ö—Ä—É–∂–æ–∫
        p.setBrush(QColor("#ffffff"))
        p.drawEllipse(int(self._circle_pos_internal), 3, self.height() - 6, self.height() - 6)

    def get_circle_position(self):
        return self._circle_pos_internal

    def set_circle_position(self, pos):
        self._circle_pos_internal = pos
        self.update()

    circle_position = pyqtProperty(float, get_circle_position, set_circle_position)


class EntryWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        self.is_maximized = False
        self.ui.btn_add_collection.setIcon(QIcon("icons/plus.svg"))
        self.ui.btn_add_collection.setIconSize(
            QSize(24, 24))  # –ø–æ–¥–≥–æ–Ω–∏ –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        self.ui.btn_header_body_show_list_1.setIcon(QIcon("icons/sort_list.svg"))
        self.replace_checkboxes_with_toggles(
            [self.ui.checkBox_muffled_voice, self.ui.checkBox_notifications, self.ui.checkBox_start_windows,
             self.ui.chk_enable_communication, self.ui.chk_external_phrases, self.ui.chk_voice_commands_enabled,
             self.ui.chk_autospell, self.ui.chk_keyboard_typing_enabled, self.ui.chk_mute_on_key_hold,
             self.ui.chk_record_when_pressed, self.ui.chk_voice_typing_enabled])
        self.ui.btn_header_body_show_list_1.setIconSize(
            QSize(24, 24))  # –ø–æ–¥–≥–æ–Ω–∏ –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        QTimer.singleShot(0,
                          self.check_config_state)  # <- –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤, –æ–∂–∏–¥–∞–µ–º –ø–æ–ª–Ω—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
        self.ui.btn_toggle_theme.clicked.connect(
            lambda: self.save_change('dark' if load_config().get("theme", "light") == 'light' else 'light'))

    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã (—Å–≤–µ—Ç–ª–∞—è –∏–ª–∏ —Ç—ë–º–Ω–∞—è)
    def check_config_state(self):
        config = load_config()
        self.apply_theme(config.get("theme", "light"))  # –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

    def replace_checkboxes_with_toggles(self, checkbox_list):
        for checkbox in checkbox_list:
            name = checkbox.objectName()
            parent = checkbox.parent()

            layout = parent.layout()  # –ø–æ–ª—É—á–∞–µ–º layout, –≤ –∫–æ—Ç–æ—Ä—ã–π –≤—Å—Ç–∞–≤–ª–µ–Ω checkbox
            if layout is None:
                continue  # –µ—Å–ª–∏ –Ω–µ—Ç layout ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

            index = layout.indexOf(checkbox)  # –ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞
            if index == -1:
                continue

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π checkbox
            item = layout.takeAt(index)
            if item:
                item.widget().deleteLater()

            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
            toggle = ToggleSwitch(parent)
            toggle.setObjectName(name)

            # –í—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ç—É –∂–µ –ø–æ–∑–∏—Ü–∏—é
            layout.insertWidget(index, toggle)

    def apply_theme(self, theme):
        if theme == "dark":
            style = DARK_MAIN + DARK_COMMANDS + DARK_SETTINGS
            self.setStyleSheet(style)
            self.ui.btn_toggle_theme.setText("‚òÄÔ∏è")
            # # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –≤—Ä—É—á–Ω—É—é
            self.ui.btn_open_github.setIcon(QIcon(Github_icon_white))

        else:
            style = LIGHT_MAIN + LIGHT_COMMANDS + LIGHT_SETTINGS
            self.setStyleSheet(style)
            self.ui.btn_toggle_theme.setText("üåô")
            # # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –≤—Ä—É—á–Ω—É—é
            self.ui.btn_open_github.setIcon(QIcon(Github_icon_black))

    def save_change(self, *args):
        config = load_config()
        if args[0] in ('dark', 'light'):
            config["theme"] = args[0]
            self.apply_theme(args[0])
        save_config(config)


def run_app():
    app = QApplication(sys.argv)
    window = EntryWindow()
    window.show()
    sys.exit(app.exec())


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = EntryWindow()
    window.show()
    sys.exit(app.exec())
